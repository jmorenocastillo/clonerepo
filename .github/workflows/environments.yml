# .github/workflows/setup-environments.yml
name: Setup Environments + Aprobadores

on:
  workflow_dispatch:

jobs:
  create-envs:
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Crear environments desde JSON
        env:
          GH_TOKEN: ${{ secrets.GH_TOKEN }}
        run: |
          set -euo pipefail

          CONFIG_FILE=".github/config/environments-config.json"

          # Lectura de configuración
          OWNER=$(jq -r '.owner' "$CONFIG_FILE")
          REPO=$(jq -r '.repository' "$CONFIG_FILE")
          USERNAME=$(jq -r '.approver_username' "$CONFIG_FILE")
          TEAM_SLUG=$(jq -r '.team_slug // empty' "$CONFIG_FILE")
          mapfile -t ENVIRONMENTS < <(jq -r '.environments[]' "$CONFIG_FILE")

          echo "Configurando $REPO para $OWNER"
          echo "Aprobador: $USERNAME"
          echo "Environments: ${ENVIRONMENTS[*]}"

          # ID del usuario aprobador
          USER_ID=$(curl -s -H "Authorization: token $GH_TOKEN" \
            "https://api.github.com/users/$USERNAME" | jq -r '.id')

          if [[ "$USER_ID" == "null" || -z "$USER_ID" ]]; then
            echo "Error: no se pudo obtener el ID del usuario $USERNAME"
            exit 1
          fi

          # Construir reviewers con jq (seguro y limpio)
          if [[ -n "$TEAM_SLUG" ]]; then
            TEAM_ID=$(curl -s -H "Authorization: token $GH_TOKEN" \
              "https://api.github.com/orgs/$OWNER/teams/$TEAM_SLUG" | jq -r '.id')
            if [[ "$TEAM_ID" != "null" && -n "$TEAM_ID" ]]; then
              REVIEWERS=$(jq -n --argjson u "$USER_ID" --argjson t "$TEAM_ID" \
                '[{"type":"User","id":$u},{"type":"Team","id":$t}]')
            else
              echo "Team $TEAM_SLUG no encontrado → solo usuario"
              REVIEWERS=$(jq -n --argjson u "$USER_ID" '[{"type":"User","id":$u}]')
            fi
          else
            REVIEWERS=$(jq -n --argjson u "$USER_ID" '[{"type":"User","id":$u}]')
          fi

          # Payload con heredoc (nunca más problemas de comillas)
          read -r -d '' PAYLOAD <<EOF
          {
            "wait_timer": 300,
            "prevent_self_review": true,
            "reviewers": $REVIEWERS,
            "deployment_branch_policy": {
              "protected_branches": true,
              "custom_branch_policies": false
            }
          }
          EOF

          # Crear cada environment
          for ENV in "${ENVIRONMENTS[@]}"; do
            echo ""
            echo "Creando/configurando environment → $ENV"
            HTTP_CODE=$(curl -s -o /tmp/response.json -w "%{http_code}" \
              -X PUT \
              -H "Authorization: token $GH_TOKEN" \
              -H "Accept: application/vnd.github+json" \
              -H "X-GitHub-Api-Version: 2022-11-28" \
              -d "$PAYLOAD" \
              "https://api.github.com/repos/$OWNER/$REPO/environments/$ENV")

            if [[ "$HTTP_CODE" == 200 || "$HTTP_CODE" == 201 ]]; then
              echo "$ENV → OK (código $HTTP_CODE)"
            else
              echo "$ENV → ERROR $HTTP_CODE"
              cat /tmp/response.json
            fi
          done

          echo ""
          echo "¡Todo terminado!"