# .github/workflows/setup-environments.yml
name: Setup Environments + Aprobadores

on:
  workflow_dispatch:

jobs:
  create-environments:
    runs-on: ubuntu-latest
    # Estos permisos son los que necesita GitHub para crear environments
    permissions:
      contents: read
      deployments: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Crear environments desde configuración
        # Usamos el token que GitHub ya nos da → siempre funciona
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          set -euo pipefail

          CONFIG=".github/config/environments.json"

          echo "Leyendo configuración desde $CONFIG"
          cat "$CONFIG"

          OWNER=$(jq -r '.owner' "$CONFIG")
          REPO=$(jq -r '.repository' "$CONFIG")
          USER=$(jq -r '.approver_username' "$CONFIG")
          TEAM=$(jq -r '.team_slug // empty' "$CONFIG")
          mapfile -t ENVS < <(jq -r '.environments[]' "$CONFIG")

          echo "Repo: $OWNER/$REPO"
          echo "Aprobador: $USER"
          echo "Environments: ${ENVS[*]}"

          # Obtener ID del aprobador
          USER_ID=$(curl -s -H "Authorization: token $GH_TOKEN" \
            "https://api.github.com/users/$USER" | jq -r '.id')

          # Construir reviewers
          if [[ -n "$TEAM" ]]; then
            TEAM_ID=$(curl -s -H "Authorization: token $GH_TOKEN" \
              "https://api.github.com/orgs/$OWNER/teams/$TEAM" | jq -r '.id')
            [[ "$TEAM_ID" != "null" ]] && TEAM_JSON=',{"type":"Team","id":'"$TEAM_ID"'}' || TEAM_JSON=""
            REVIEWERS='[{"type":"User","id":'"$USER_ID"'}"'"$TEAM_JSON"']'
          else
            REVIEWERS='[{"type":"User","id":'"$USER_ID"'}]'
          fi

          # Payload final (usamos printf para evitar cualquier problema de comillas)
          PAYLOAD=$(printf '{
            "wait_timer": 300,
            "prevent_self_review": true,
            "reviewers": %s,
            "deployment_branch_policy": {
              "protected_branches": true,
              "custom_branch_policies": false
            }
          }' "$REVIEWERS")

          # Crear cada environment
          for env in "${ENVS[@]}"; do
            echo -e "\nCreando/configurando → $env"
            code=$(curl -s -o response.json -w "%{http_code}" \
              -X PUT \
              -H "Authorization: token $GH_TOKEN" \
              -H "Accept: application/vnd.github+json" \
              -H "X-GitHub-Api-Version: 2022-11-28" \
              -d "$PAYLOAD" \
              "https://api.github.com/repos/$OWNER/$REPO/environments/$env")

            if [[ "$code" == 200 || "$code" == 201 ]]; then
              echo "$env → OK"
            else
              echo "$env → Error $code"
              cat response.json
            fi
          done

          echo -e "\nTodos los environments configurados correctamente"