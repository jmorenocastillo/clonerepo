# .github/workflows/setup-environments.yml
name: Setup Environments + Aprobadores

on:
  workflow_dispatch:   # Puedes ejecutarlo manualmente cuando cambies el JSON

jobs:
  create-envs:
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Leer configuración y crear environments
        env:
          GH_TOKEN: ${{ secrets.GH_TOKEN }}  # PAT con repo + read:org (si usas teams)
        run: |
          CONFIG_FILE=".github/config/environments-config.json"

          # Validar que el archivo existe
          if [ ! -f "$CONFIG_FILE" ]; then
            echo "Error: No se encontró el archivo de configuración $CONFIG_FILE"
            exit 1
          fi

          # Leer valores del JSON usando jq
          OWNER=$(jq -r '.owner' "$CONFIG_FILE")
          REPO=$(jq -r '.repository' "$CONFIG_FILE")
          USERNAME=$(jq -r '.approver_username' "$CONFIG_FILE")
          TEAM_SLUG=$(jq -r '.team_slug // empty' "$CONFIG_FILE")
          ENVIRONMENTS=($(jq -r '.environments[]' "$CONFIG_FILE"))

          echo "Owner: $OWNER
          echo "Repo: $REPO"
          echo "Aprobador: $USERNAME"
          [ -n "$TEAM_SLUG" ] && echo "Equipo aprobador: $TEAM_SLUG"
          echo "Environments a crear: ${ENVIRONMENTS[@]}"

          # Obtener ID del usuario aprobador
          USER_ID=$(curl -s -H "Authorization: token $GH_TOKEN" \
            "https://api.github.com/users/$USERNAME" | jq -r '.id')

          if [ "$USER_ID" = "null" ] || [ -z "$USER_ID" ]; then
            echo "Error: No se pudo obtener el ID del usuario $USERNAME"
            exit 1
          fi

          # Construir reviewers (usuario + equipo opcional)
          if [ -n "$TEAM_SLUG" ]; then
            TEAM_ID=$(curl -s -H "Authorization: token $GH_TOKEN" \
              "https://api.github.com/orgs/$OWNER/teams/$TEAM_SLUG" | jq -r '.id')
            if [ "$TEAM_ID" != "null" ]; then
              REVIEWERS='[{"type":"User","id":'"$USER_ID"'},{"type":"Team","id":'"$TEAM_ID"'}]'
            else
              echo "Advertencia: Equipo $TEAM_SLUG no encontrado, solo se usará el usuario"
              REVIEWERS='[{"type":"User","id":'"$USER_ID"'}]'
            fi
          else
            REVIEWERS='[{"type":"User","id":'"$USER_ID"'}]'
          fi

          # Payload común
          PAYLOAD='{
            "wait_timer": 300,
            "prevent_self_review": true,
            "reviewers": '"$REVIEWERS"',
            "deployment_branch_policy": {
              "protected_branches": true,
              "custom_branch_policies": false
            }
          }'

          # Crear cada environment
          for ENV in "${ENVIRONMENTS[@]}"; do
            echo ""
            echo "Configurando environment: $ENV"

            http_code=$(curl -s -o response.json -w "%{http_code}" \
              -X PUT \
              -H "Authorization: token $GH_TOKEN" \
              -H "Accept: application/vnd.github+json" \
              -H "X-GitHub-Api-Version: 2022-11-28" \
              -d "$PAYLOAD" \
              "https://api.github.com/repos/$OWNER/$REPO/environments/$ENV")

            if [ "$http_code" = "200" ] || [ "$http_code" = "201" ]; then
              echo "Environment $ENV configurado correctamente"
            else
              echo "Error $http_code en $ENV"
              cat response.json
            fi
          done