# .github/workflows/setup-environments.yml
name: Setup Environments + Aprobadores

on:
  workflow_dispatch:

jobs:
  create-envs:
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Configurar environments desde JSON (con debug total)
        env:
          GH_TOKEN: ${{ secrets.GH_TOKEN }}
        run: |
          set -euo pipefail  # Esto hace que el script muera en cualquier error y lo veamos

          echo "=== PASO 1: Verificamos que el archivo existe ==="
          CONFIG_FILE=".github/config/environments-config.json"
          ls -la .github/config/ || echo "No existe la carpeta .github/config/"
          cat "$CONFIG_FILE" && echo "Archivo leído correctamente" || (echo "No se pudo leer $CONFIG_FILE" && exit 1)

          echo ""
          echo "=== PASO 2: Instalamos jq si falta (por si acaso) ==="
          jq --version || sudo apt-get update && sudo apt-get install -y jq

          echo ""
          echo "=== PASO 3: Leemos configuración con jq ==="
          OWNER=$(jq -r '.owner' "$CONFIG_FILE")
          REPO=$(jq -r '.repository' "$CONFIG_FILE")
          USERNAME=$(jq -r '.approver_username' "$CONFIG_FILE")
          TEAM_SLUG=$(jq -r '.team_slug // empty' "$CONFIG_FILE")
          echo "Owner:          $OWNER"
          echo "Repository:     $REPO"
          echo "Approver user:  $USERNAME"
          echo "Team slug:      '$TEAM_SLUG'"

          echo ""
          echo "=== PASO 4: Leemos la lista de environments ==="
          mapfile -t ENVIRONMENTS < <(jq -r '.environments[]' "$CONFIG_FILE")
          echo "Encontrados ${#ENVIRONMENTS[@]} environments:"
          printf '  - %s\n' "${ENVIRONMENTS[@]}"

          if [ ${#ENVIRONMENTS[@]} -eq 0 ]; then
            echo "Error: la lista de environments está vacía"
            exit 1
          fi

          echo ""
          echo "=== PASO 5: Obtenemos ID del usuario aprobador ==="
          USER_RESPONSE=$(curl -s -H "Authorization: token $GH_TOKEN" \
            "https://api.github.com/users/$USERNAME")
          echo "Respuesta API usuario:"
          echo "$USER_RESPONSE" | jq .
          USER_ID=$(echo "$USER_RESPONSE" | jq -r '.id')
          echo "USER_ID = $USER_ID"
          [ "$USER_ID" = "null" ] || [ -z "$USER_ID" ] && echo "Error: usuario no encontrado o token sin permiso" && exit 1

          # El resto ya funciona (lo dejamos igual pero con más echo)
          if [ -n "$TEAM_SLUG" ]; then
            TEAM_ID=$(curl -s -H "Authorization: token $GH_TOKEN" \
              "https://api.github.com/orgs/$OWNER/teams/$TEAM_SLUG" | jq -r '.id')
            if [ "$TEAM_ID" != "null" ]; then
              REVIEWERS=$(jq -n --argjson u "$USER_ID" --argjson t "$TEAM_ID" \
                '[{"type":"User","id":$u},{"type":"Team","id":$t}]')
            else
              echo "Team no encontrado → solo usuario"
              REVIEWERS=$(jq -n --argjson u "$USER_ID" '[{"type":"User","id":$u}]')
            fi
          else
            REVIEWERS=$(jq -n --argjson u "$USER_ID" '[{"type":"User","id":$u}]')
          fi

          read -r -d '' PAYLOAD <<EOF
          {
            "wait_timer": 300,
            "prevent_self_review": true,
            "reviewers": $REVIEWERS,
            "deployment_branch_policy": {
              "protected_branches": true,
              "custom_branch_policies": false
            }
          }
          EOF

          echo ""
          echo "=== PAYLOAD que se va a enviar ==="
          echo "$PAYLOAD" | jq .

          for ENV in "${ENVIRONMENTS[@]}"; do
            echo ""
            echo "Configurando → $ENV"
            curl -i -X PUT \
              -H "Authorization: token $GH_TOKEN" \
              -H "Accept: application/vnd.github+json" \
              -H "X-GitHub-Api-Version: 2022-11-28" \
              -d "$PAYLOAD" \
              "https://api.github.com/repos/$OWNER/$REPO/environments/$ENV"
          done