# .github/workflows/setup-environments.yml
name: Setup Environments - Funciona 100%

on:
  workflow_dispatch:

jobs:
  setup:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      deployments: write
      actions: read

    env:
      GH_TOKEN: ${{ secrets.GH_TOKEN }}   # PAT con scope "repo" (Administration read+write)

    steps:
      - name: Crear environments automáticamente desde nombres de jobs
        run: |
          # ┌─────────────────────────────────────────────┐
          # │ CAMBIA SOLO ESTAS 3 LÍNEAS                  │
          # └─────────────────────────────────────────────┘
          OWNER="jmorenocastillo"          # ej: acme-corp
          REPO="clonerepo"                    # ej: infra-azure
          APROBADOR="jmorenocastillo"            # usuario GitHub que será aprobador
          # ┌─────────────────────────────────────────────┐

          # ID del aprobador
          USER_ID=$(curl -s -H "Authorization: token $GH_TOKEN" \
            "https://api.github.com/users/$APROBADOR" | jq -r .id)

          echo "Buscando jobs en todos los workflows del repo..."

          # Detectar todos los nombres de jobs (sin errores de base64 ni EOF)
          JOB_NAMES=$(gh api -H "Accept: application/vnd.github+json" \
            "/repos/$OWNER/$REPO/actions/workflows" --jq '.workflows[].path' | \
            while IFS= read -r path; do
              content=$(gh api -H "Accept: application/vnd.github+json" \
                "/repos/$OWNER/$REPO/contents/$path" --jq '.content // empty')
              if [ -n "$content" ]; then
                echo "$content" | base64 -d 2>/dev/null | \
                  yq eval '.jobs | keys | .[]' - 2>/dev/null
              fi
            done | sort -u)

          # Excluir jobs que NO queremos como environments
          JOB_NAMES=$(echo "$JOB_NAMES" | grep -vE '^(setup|create|configure|detect|lint|test|ci|check|format|setup-environments)' || true)

          # Fallback por