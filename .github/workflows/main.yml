# .github/workflows/setup-environments-100-dynamic.yml
name: Setup Environments 100% Dinámico (sin listas)

on:
  workflow_dispatch:   # Ejecuta manualmente una vez (o ponlo en main si quieres que se ejecute siempre)

permissions:
  contents: read
  deployments: write
  actions: read        # Necesario para leer workflows

jobs:
  detect-and-create:
    runs-on: ubuntu-latest
    env:
      GH_TOKEN: ${{ secrets.GH_TOKEN }}   # PAT con "repo" scope (Administration read+write)

    steps:
      - name: Detectar automáticamente todos los jobs y crear environments
        run: |
          # =============================================
          # SOLO CAMBIA ESTO (2 líneas)
          # =============================================
          OWNER="jmorenocastillo"          # ej: acme-corp
          REPO="clonerepo"                    # ej: infra-azure
          APROBADOR="jmorenocastillo"            # usuario GitHub que será aprobador
          # TEAM_SLUG="sre-team"            # descomenta si quieres team también
          # =============================================

          # Obtener ID del aprobador
          USER_ID=$(curl -s -H "Authorization: token $GH_TOKEN" \
            https://api.github.com/users/$APROBADOR | jq -r .id)

          # Opcional: ID del team
          # TEAM_ID=$(curl -s -H "Authorization: token $GH_TOKEN" \
          #   https://api.github.com/orgs/$OWNER/teams/$TEAM_SLUG | jq -r .id)
          # TEAM_JSON=",{\"type\":\"Team\",\"id\":$TEAM_ID}"

          # =============================================
          # MAGIA: Detecta TODOS los jobs definidos en TODOS los workflows .yml
          # =============================================
          echo "Buscando jobs en todos los workflows..."

          JOB_NAMES=$(gh api \
            -H "Accept: application/vnd.github+json" \
            "/repos/$OWNER/$REPO/actions/workflows" \
            --jq '.workflows[].path' | \
            xargs -I {} gh api \
              -H "Accept: application/vnd.github+json" \
              "/repos/$OWNER/$REPO/contents/{}" | \
            jq -r 'select(.content != null) | @base64d // .content' | \
            yq eval '.jobs | keys | .[]' - 2>/dev/null || true)

          # Filtrado opcional: solo jobs que NO empiecen con "setup" o "create"
          JOB_NAMES=$(echo "$JOB_NAMES" | grep -vE '^(setup|create|detect|configure)' || true)

          # Si no encuentra nada, usa fallback razonable
          [ -z "$JOB_NAMES" ] && JOB_NAMES="dev pre pro"

          echo "Jobs detectados → se crearán estos environments:"
          echo "$JOB_NAMES" | tr '\n' ' ' | xargs -n1 echo "  →"

          # =============================================
          # Crear/configurar cada environment
          # =============================================
          for ENV