# .github/workflows/setup-environments-dynamic.yml
name: Setup Environments 100% Dinámico (sin errores)

on:
  workflow_dispatch

permissions:
  contents: read
  deployments: write
  actions: read

jobs:
  create:
    runs-on: ubuntu-latest
    env:
      GH_TOKEN: ${{ secrets.GH_TOKEN }}   # PAT con repo scope

    steps:
      - name: Detectar jobs y crear environments automáticamente
        run: |
          # =============================================
          # CAMBIA SOLO ESTO (3 líneas)
          # =============================================
          OWNER="jmorenocastillo"          # ej: acme-corp
          REPO="clonerepo"                    # ej: infra-azure
          APROBADOR="jmorenocastillo"            # usuario GitHub que será aprobador
          # =============================================

          USER_ID=$(curl -s -H "Authorization: token $GH_TOKEN" \
            https://api.github.com/users/$APROBADOR | jq -r .id)

          echo "Detectando jobs en todos los workflows..."

          JOB_NAMES=$(gh api \
            -H "Accept: application/vnd.github+json" \
            "/repos/$OWNER/$REPO/actions/workflows" \
            --jq '.workflows[].path' | while read -r path; do
              content=$(gh api \
                -H "Accept: application/vnd.github+json" \
                "/repos/$OWNER/$REPO/contents/$path" --jq '.content // empty')
              [ -n "$content" ] && echo "$content" | base64 -d | yq eval '.jobs | keys | .[]' -