name: Terraform - Plan Real + Approval UI

on:
  push:
    branches: [ main ]

jobs:
  terraform:
    environment: production
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
    
    - name: Terraform Plan (SIMULADO)
      run: |
        echo "=== 🗺️ TERRAFORM PLAN ===" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Terraform used the selected providers to generate the following execution plan.**" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "# aws_instance.web will be created" >> $GITHUB_STEP_SUMMARY
        echo "+ resource \"aws_instance\" \"web\" {" >> $GITHUB_STEP_SUMMARY
        echo "    + ami           = \"ami-0abcdef1234567890\"" >> $GITHUB_STEP_SUMMARY
        echo "    + instance_type = \"t3.micro\"" >> $GITHUB_STEP_SUMMARY
        echo "    + tags = {" >> $GITHUB_STEP_SUMMARY
        echo "        + Name = \"web-server-01\"" >> $GITHUB_STEP_SUMMARY
        echo "      }" >> $GITHUB_STEP_SUMMARY
        echo "  }" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "# aws_s3_bucket.static will be created" >> $GITHUB_STEP_SUMMARY
        echo "+ resource \"aws_s3_bucket\" \"static\" {" >> $GITHUB_STEP_SUMMARY
        echo "    + bucket = \"my-static-site-20251016\"" >> $GITHUB_STEP_SUMMARY
        echo "  }" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "# aws_db_instance.app will be *MODIFIED*" >> $GITHUB_STEP_SUMMARY
        echo "resource \"aws_db_instance\" \"app\" {" >> $GITHUB_STEP_SUMMARY
        echo "    ~ allocated_storage = 20 -> 50  # ← +30GB" >> $GITHUB_STEP_SUMMARY
        echo "    ~ instance_class    = \"db.t3.micro\" -> \"db.t3.small\"  # ← Upgrade" >> $GITHUB_STEP_SUMMARY
        echo "  }" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "# aws_security_group.old will be *DESTROYED*" >> $GITHUB_STEP_SUMMARY
        echo "- resource \"aws_security_group\" \"old\" {" >> $GITHUB_STEP_SUMMARY
        echo "    - id = \"sg-0123456789abcdef0\"" >> $GITHUB_STEP_SUMMARY
        echo "  }" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Plan: 2 to add, 1 to change, 1 to destroy.**" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**👇 REVISA EL PLAN ARRIBA 👆 y decide si APPROVE**" >> $GITHUB_STEP_SUMMARY
        echo "---" >> $GITHUB_STEP_SUMMARY
    
    - name: Terraform Apply
      run: |
        echo "=== ✅ TERRAFORM APPLY COMPLETED ===" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**✨ DEPLOY EXITOSO A PRODUCTION!**" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ✅ Cambios Aplicados:" >> $GITHUB_STEP_SUMMARY
        echo "| Acción | Recurso | Detalles |" >> $GITHUB_STEP_SUMMARY
        echo "|--------|---------|----------|" >> $GITHUB_STEP_SUMMARY
        echo "| **CREADO** | aws_instance.web | t3.micro • web-server-01 |" >> $GITHUB_STEP_SUMMARY
        echo "