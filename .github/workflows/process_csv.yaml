name: Terraform - PLAN PRIMERO ‚Üí APPROVE ‚Üí APPLY

on:
  push:
    branches: [ main ]

jobs:
  # JOB 1: PLAN (SE VE INMEDIATO - SIN PAUSA)
  plan:
    runs-on: ubuntu-latest
    outputs:
      plan-complete: true
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
    
    - name: Terraform Plan (VISIBLE AHORA)
      run: |
        echo "=============================================="
        echo "üó∫Ô∏è  TERRAFORM PLAN - REVISA Y DECIDE"
        echo "=============================================="
        echo ""
        echo "# aws_instance.web will be created"
        echo "+ ami           = \"ami-0abcdef1234567890\""
        echo "+ instance_type = \"t3.micro\""
        echo "+ tags          = { Name = \"web-server-01\" }"
        echo ""
        echo "# aws_s3_bucket.static will be created"
        echo "+ bucket = \"my-static-site-20251016\""
        echo ""
        echo "# aws_db_instance.app will be MODIFIED"
        echo "~ allocated_storage = 20 -> 50  # +30GB ($30/mes extra)"
        echo "~ instance_class    = \"db.t3.micro\" -> \"db.t3.small\""
        echo ""
        echo "# aws_security_group.old will be DESTROYED"
        echo "- id = \"sg-0123456789abcdef0\""
        echo ""
        echo "=============================================="
        echo "**Plan: 2 to add, 1 to change, 1 to destroy**"
        echo "=============================================="
        echo ""
        echo "‚úÖ PLAN COMPLETADO - REVISAR EN JOB 2"

  # JOB 2: APPROVAL + APPLY (PAUSA CON BOT√ìN)
  deploy:
    needs: plan  # ‚Üê ESPERA AL PLAN
    environment: production  # ‚Üê BOT√ìN AQU√ç
    runs-on: ubuntu-latest
    
    steps:
    - name: ‚è∏Ô∏è APPROVAL - Revisa Plan de arriba
      run: echo "PLAN VISIBLE EN JOB 'plan' ‚úì - Click APPROVE"
    
    - name: Terraform Apply (S√ìLO SI APPROVES)
      run: |
        echo "=============================================="
        echo "‚úÖ TERRAFORM APPLY COMPLETED!"
        echo "=============================================="
        echo "| Acci√≥n     | Recurso              | Costo |"
        echo "|------------|----------------------|-------|"
        echo "| CREATED ‚úì  | aws_instance.web     | $10/m |"
        echo "| CREATED ‚úì  | aws_s3_bucket.static | $5/m  |"
        echo "| MODIFIED ‚úì | aws_db_instance.app  | +$30/m|"
        echo "| DESTROYED ‚úì| aws_security_group.old| -$2/m |"
        echo "| **TOTAL**  |                      | **$43/m** |"
        echo "=============================================="