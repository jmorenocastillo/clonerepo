# .github/workflows/create-environments.yml
name: Crear Environments automáticamente

# Se ejecuta manualmente o cada vez que cambies el workflow que contiene los jobs
on:
  workflow_dispatch:
  push:
    branches:
      - main
    paths:
      - '.github/workflows/deploy.yml'   # ← si tu workflow se llama distinto, cámbialo aquí

permissions:
  contents: read
  deployments: write

jobs:
  create:
    runs-on: ubuntu-latest
    steps:
      - name: Crear environments = nombres de jobs
        env:
          GH_TOKEN: ${{ secrets.GH_TOKEN }}   # PAT con permiso repo → Administration read+write
        run: |
          # =============================================
          # CAMBIA SÓLO ESTAS 2 LÍNEAS
          # =============================================
          APROBADOR="jmorenocastillo"              # ← tu usuario de GitHub
          WORKFLOW_FILE="deploy.yml"          # ← nombre exacto de tu workflow con los jobs
          # =============================================

          USER_ID=$(curl -s -H "Authorization: token $GH_TOKEN" \
            https://api.github.com/users/$APROBADOR | jq -r .id)

          # Lee el archivo del workflow y extrae los nombres de los jobs (una línea por job)
          JOBS=$(gh api \
            -H "Accept: application/vnd.github+json" \
            "/repos/${{ github.repository }}/contents/.github/workflows/$WORKFLOW_FILE" \
            --jq '.content' | base64 -d | grep -E '^[[:space:]]*[a-zA-Z0-9_-]+:' | sed 's/:.*$//' | tr -d ' ')

          echo "Jobs detectados → se crearán estos environments:"
          echo "$JOBS" | sed 's/^/  → /'

          for ENV in $JOBS; do
            echo "Creando/configurando → $ENV"

            curl -X PUT \
              -H "Authorization: token $GH_TOKEN" \
              -H "Accept: application/vnd.github+json" \
              "https://api.github.com/repos/${{ github.repository }}/environments/$ENV" \
              -H "Content-Type: application/json" \
              -d '{
                "wait_timer": 300,
                "prevent_self_review": true,
                "reviewers": [{"type":"User","id":'"$USER_ID"'}],
                "deployment_branch_policy": {"protected_branches": true}
              }' \
              -s && echo "OK → $ENV listo"
          done

          echo "¡Terminado! Todos los environments están sincronizados con los jobs de $WORKFLOW_FILE"