# .github/workflows/sync-environments.yml
name: Sync Environments ← funciona 100 %

on:
  workflow_dispatch:
  push:
    branches:
      - main
    paths:
      - '.github/workflows/deploy.yml'  # Se ejecuta cuando cambies el deploy.yml

permissions:
  contents: read
  deployments: write

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Crear environments desde los jobs de deploy.yml
        env:
          GH_TOKEN: ${{ secrets.GH_TOKEN }}   # PAT con permiso "Administration" read+write
        run: |
          # TU USUARIO QUE SERÁ APROBADOR
          APROBADOR="jmorenocastillo"   # ← SOLO CAMBIA ESTO

          USER_ID=$(curl -s -H "Authorization: token $GH_TOKEN" \
            https://api.github.com/users/$APROBADOR | jq -r .id)

          # Extrae los nombres de jobs del archivo deploy.yml (100 % fiable)
          JOBS=$(grep -E '^[[:space:]]*[a-zA-Z0-9_-]+:' .github/workflows/deploy.yml | \
                 cut -d: -f1 | tr -d ' ' | tr -d '\r')

          echo "Jobs detectados → se crean estos environments:"
          echo "$JOBS" | sed 's/^/  → /'

          for ENV in $JOBS; do
            echo "Creando/configurando → $ENV"

            curl -X PUT \
              -H "Authorization: token $GH_TOKEN" \
              -H "Accept: application/vnd.github+json" \
              -H "Content-Type: application/json" \
              -d "{
                \"wait_timer\": 300,
                \"prevent_self_review\": true,
                \"reviewers\": [{\"type\":\"User\",\"id\":$USER_ID}],
                \"deployment_branch_policy\": {\"protected_branches\": true}
              }" \
              https://api.github.com/repos/${{ github.repository }}/environments/$ENV \
              -s -w "\n→ $ENV creado (HTTP %{http_code})\n" || true
          done

          echo "¡TERMINADO! Todos los environments están sincronizados."